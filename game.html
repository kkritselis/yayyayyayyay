<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game - Yay! Yay! Yay! Yay!</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        /* Game-specific styles */
        #container { 
            display: flex; 
            gap: 20px; 
            margin-top: 10px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
            max-width: 800px;
        }

        .circleBox, .slots { 
            background: #222; 
            padding: 10px; 
            border-radius: 8px; 
            display: flex; 
            flex-wrap: wrap; 
            gap: 10px; 
            width: min(250px, calc(100% - 20px));
            min-height: 60px;
            justify-content: center;
            align-content: flex-start;
        }

        #historyPanel {
            background: #222;
            border-radius: 8px;
            margin: 20px auto;
            width: 100%;
            max-width: 800px;
        }

        .attempt {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 10px;
            border-bottom: 1px solid #444;
            animation: fadeIn 0.3s ease-out;
        }

        .attempt:last-child {
            border-bottom: none;
        }

        .attempt-circles {
            display: flex;
            gap: 5px;
        }

        .attempt-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 1px solid #0008;
        }

        .feedback-dots {
            display: flex;
            gap: 5px;
            margin-left: auto;
        }

        .feedback-dot {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            border: 1px solid #fff4;
        }

        .feedback-dot.correct-place {
            background: #0f0;
        }

        .feedback-dot.wrong {
            background: #444;
        }

        .legend {
            display: flex;
            gap: 15px;
            justify-content: center;
            padding: 10px;
            border-bottom: 1px solid #444;
            font-size: 14px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        @media (max-width: 600px) {
            .attempt {
                flex-wrap: wrap;
            }
            .feedback-dots {
                margin-left: 0;
                margin-top: 5px;
            }
            .attempt-circle {
                width: 15px;
                height: 15px;
            }
            .feedback-dot {
                width: 8px;
                height: 8px;
            }
        }
    </style>
</head>
<body>
    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 800px; margin-bottom: 20px;">
        <a href="index.html">
            <img src="logo_sub.png" alt="Yay! Yay! Yay! Yay!" style="width: 100%;">
        </a>
    </div>

    <div id="container">
        <div class="circleBox" id="circleBox"></div>
        <div class="slots" id="slots"></div>
    </div>

    <div class="canvas-container">
        <canvas id="canvas" width="400" height="350"></canvas>
        <div id="audioToggle" class="audio-toggle" title="Toggle Audio">ðŸ”Š</div>
    </div>

    <div id="historyPanel">
        <div class="legend">
            <div class="legend-item">
                <div class="feedback-dot correct-place"></div>
                <span>Correct circle</span>
            </div>
            <div class="legend-item">
                <div class="feedback-dot wrong"></div>
                <span>Wrong circle</span>
            </div>
        </div>
        <div id="attemptsHistory"></div>
    </div>

    <div id="message" class="message">Correct!</div>
    <div>
        <button id="nextBtn" class="button">Next Level</button>
        <button id="solveBtn" class="button">Show Solution</button>
    </div>

    <script type="module">
        import { initAudio, updateCircleAudio, createDrumSound, updateCircleVolume, updateAllAudio, stopAllAudio } from './js/audio.js';
        import { computeTarget, draw, startDrawing, stopDrawing, setGlowTimer } from './js/animation.js';
        import { setupDragAndDrop, setupSlot } from './js/dragdrop.js';
        import { createAnimation, createSlotAnimation } from './js/circle-animation.js';

        import { levels } from './js/levels.js';

        let currentLevel = 0;
        let circles = [];
        let targetPoints = [];
        let attempts = [];

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const box = document.getElementById('circleBox');
        const slotContainer = document.getElementById('slots');
        const message = document.getElementById('message');
        const nextBtn = document.getElementById('nextBtn');
        const solveBtn = document.getElementById('solveBtn');

        function loadLevel(n) {
            const L = levels[n];
            targetPoints = computeTarget(L.target);
            
            // Clear existing canvases
            const allCanvases = document.querySelectorAll('.circle canvas, .slot canvas');
            allCanvases.forEach(canvas => {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            });

            // Reset containers and UI
            box.innerHTML = "";
            slotContainer.innerHTML = "";
            nextBtn.style.display = "none";
            solveBtn.style.display = "none"; 
            canvas.style.boxShadow = "none";
            document.getElementById('attemptsHistory').innerHTML = "";
            attempts = [];
            
            stopDrawing();
            stopAllAudio();

            // Create circles
            circles = [...L.target, ...L.decoys.slice(0, 2)].sort(() => Math.random() - 0.5);
            circles.forEach(circle => {
                const div = document.createElement("div");
                div.className = "circle";
                div.dataset.id = circle.id;
                div.dataset.r = circle.r;
                div.dataset.f = circle.f;
                div.dataset.p = circle.p;
                div.dataset.color = circle.color;
                
                const canvas = document.createElement("canvas");
                const isMobile = window.innerWidth <= 600;
                canvas.width = isMobile ? 40 : 100;
                canvas.height = isMobile ? 40 : 100;
                div.appendChild(canvas);

                setupDragAndDrop(div);
                box.appendChild(div);
            });

            // Create slots
            const targetCount = L.target.length;
            for (let i = 0; i < targetCount; i++) {
                const slot = document.createElement("div");
                slot.className = "slot";
                
                const placeholder = document.createElement("div");
                placeholder.className = "placeholder";
                placeholder.innerText = "drop";
                slot.appendChild(placeholder);
                
                const canvas = document.createElement("canvas");
                const isMobile = window.innerWidth <= 600;
                canvas.width = isMobile ? 40 : 100;
                canvas.height = isMobile ? 40 : 100;
                slot.appendChild(canvas);
                
                setupSlot(slot, id => circles.find(c => c.id === id));
                slotContainer.appendChild(slot);
            }

            // Add check button
            const buttonContainer = document.createElement("div");
            buttonContainer.id = "buttonContainer";
            buttonContainer.style.cssText = "display: flex; justify-content: center; margin: 10px; width: 100%;";
            
            const checkBtn = document.createElement("button");
            checkBtn.id = "checkBtn";
            checkBtn.className = "button";
            checkBtn.innerText = "Check Solution";
            
            checkBtn.addEventListener("click", checkAttempt);
            checkBtn.addEventListener("touchend", (e) => {
                e.preventDefault();
                checkAttempt();
            });
            
            buttonContainer.appendChild(checkBtn);
            slotContainer.appendChild(buttonContainer);

            // Setup audio toggle
            const audioToggle = document.getElementById('audioToggle');
            if (audioToggle) {
                audioToggle.addEventListener("click", toggleAudio);
                audioToggle.addEventListener("touchend", (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleAudio();
                });
            }

            showMessage(`Level: ${L.name}`);
        }

        function checkAttempt() {
            try {
                const activeSlots = Array.from(slotContainer.querySelectorAll(".slot"));
                const activeIDs = activeSlots.map(s => s.dataset.id).filter(id => id);
                
                const targetCount = levels[currentLevel].target.length;
                
                if (activeIDs.length !== targetCount) {
                    showMessage(`Fill all ${targetCount} slots to check your solution`);
                    return;
                }

                startDrawing();
                initAudio();
                
                const activeCircles = activeIDs.map(id => circles.find(c => c.id === id));
                updateAllAudio(activeCircles);
                draw(ctx, targetPoints, circles, slotContainer, canvas);

                const targetIDs = levels[currentLevel].target.map(c => c.id);
                let correctCircles = 0;
                
                activeIDs.forEach(id => {
                    if (targetIDs.includes(id)) {
                        correctCircles++;
                    }
                });
                
                const hasAllTargetCircles = targetIDs.every(targetID => activeIDs.includes(targetID));

                // Record attempt
                const attempt = {
                    circles: activeIDs.map(id => circles.find(c => c.id === id)),
                    feedback: {
                        correctCircles,
                        wrong: targetCount - correctCircles
                    }
                };
                attempts.push(attempt);
                
                // Update history panel
                updateHistoryPanel(attempt);

                showMessage(`Attempt ${attempts.length}: ${correctCircles} correct circles`);
                
                if (correctCircles === targetCount && hasAllTargetCircles) {
                    triggerVictory();
                } else {
                    handleIncorrectAttempt(activeSlots);
                }
            } catch (error) {
                console.error('Error in checkAttempt:', error);
                showMessage('An error occurred while checking your solution');
            }
        }

        function updateHistoryPanel(attempt) {
            const historyDiv = document.getElementById('attemptsHistory');
            const attemptDiv = document.createElement('div');
            attemptDiv.className = 'attempt';

            // Add circles
            const circlesDiv = document.createElement('div');
            circlesDiv.className = 'attempt-circles';
            attempt.circles.forEach(circle => {
                const circleDiv = document.createElement('div');
                circleDiv.className = 'attempt-circle';
                circleDiv.style.background = circle.color;
                circlesDiv.appendChild(circleDiv);
            });
            attemptDiv.appendChild(circlesDiv);

            // Add feedback dots
            const feedbackDiv = document.createElement('div');
            feedbackDiv.className = 'feedback-dots';
            
            for (let i = 0; i < attempt.feedback.correctCircles; i++) {
                const dot = document.createElement('div');
                dot.className = 'feedback-dot correct-place';
                feedbackDiv.appendChild(dot);
            }
            
            for (let i = 0; i < attempt.feedback.wrong; i++) {
                const dot = document.createElement('div');
                dot.className = 'feedback-dot wrong';
                feedbackDiv.appendChild(dot);
            }
            
            attemptDiv.appendChild(feedbackDiv);
            historyDiv.insertBefore(attemptDiv, historyDiv.firstChild);
        }

        function handleIncorrectAttempt(activeSlots) {
            const buttonContainer = document.getElementById('buttonContainer');
            const checkBtn = document.getElementById('checkBtn');
            if (buttonContainer && checkBtn) {
                const tryAgainBtn = document.createElement("button");
                tryAgainBtn.id = "tryAgainBtn";
                tryAgainBtn.className = "button";
                tryAgainBtn.innerText = "Try Again";
                
                const handleTryAgain = () => {
                    resetSlots(activeSlots);
                    const newCheckBtn = createCheckButton();
                    buttonContainer.replaceChild(newCheckBtn, tryAgainBtn);
                };
                
                tryAgainBtn.addEventListener("click", handleTryAgain);
                tryAgainBtn.addEventListener("touchend", (e) => {
                    e.preventDefault();
                    handleTryAgain();
                });
                
                checkBtn.style.transition = "opacity 0.3s";
                checkBtn.style.opacity = "0";
                setTimeout(() => {
                    buttonContainer.replaceChild(tryAgainBtn, checkBtn);
                }, 300);
                
                // Lock all slots
                document.querySelectorAll('.slot').forEach(slot => {
                    slot.classList.add('locked');
                });
            }
        }

        function resetSlots(slots) {
            slots.forEach(slot => {
                if (slot.animationId) {
                    cancelAnimationFrame(slot.animationId);
                    slot.animationId = null;
                }
                
                slot.innerHTML = '';
                slot.classList.remove('filled');
                slot.classList.remove('locked');
                slot.style.border = '2px dashed #555';
                
                const placeholder = document.createElement("div");
                placeholder.className = "placeholder";
                placeholder.innerText = "drop";
                slot.appendChild(placeholder);
                
                const canvas = document.createElement("canvas");
                const isMobile = window.innerWidth <= 600;
                canvas.width = isMobile ? 40 : 100;
                canvas.height = isMobile ? 40 : 100;
                slot.appendChild(canvas);
            });
            
            stopDrawing();
            stopAllAudio();
        }

        function createCheckButton() {
            const btn = document.createElement("button");
            btn.id = "checkBtn";
            btn.className = "button";
            btn.innerText = "Check Solution";
            
            btn.addEventListener("click", checkAttempt);
            btn.addEventListener("touchend", (e) => {
                e.preventDefault();
                checkAttempt();
            });
            
            return btn;
        }

        function triggerVictory() {
            showMessage("ðŸŽ‰ Correct!");
            
            if (currentLevel === levels.length - 1) {
                showVictoryModal();
            } else {
                // Replace check button with next button
                const buttonContainer = document.getElementById('buttonContainer');
                const checkBtn = document.getElementById('checkBtn');
                if (buttonContainer && checkBtn) {
                    const nextBtn = document.createElement("button");
                    nextBtn.className = "button";
                    nextBtn.innerText = "Next Level";
                    
                    const handleNextLevel = () => {
                        currentLevel++;
                        loadLevel(currentLevel);
                    };
                    
                    nextBtn.addEventListener("click", handleNextLevel);
                    nextBtn.addEventListener("touchend", (e) => {
                        e.preventDefault();
                        handleNextLevel();
                    });
                    
                    checkBtn.style.transition = "opacity 0.3s";
                    checkBtn.style.opacity = "0";
                    setTimeout(() => {
                        buttonContainer.replaceChild(nextBtn, checkBtn);
                    }, 300);
                }
            }
            
            solveBtn.style.display = "none"; 
            setGlowTimer(120);
        }

        function showVictoryModal() {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            
            modal.innerHTML = `
                <div class="victory-title">Congratulations!</div>
                <div class="victory-message">
                    You've attained the Rank of<br>
                    <strong>Loop Master!</strong><br><br>
                    You've mastered the art of epicycles and can now create any shape with the power of rotating circles!
                </div>
                <a href="index.html" class="button">Return Home</a>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.remove();
                }
            });
        }

        function showMessage(txt) {
            message.innerText = txt;
            message.style.opacity = txt ? 1 : 0;
        }

        function toggleAudio() {
            window.audioEnabled = !window.audioEnabled;
            const toggleBtn = document.getElementById('audioToggle');
            
            if (window.audioEnabled) {
                toggleBtn.textContent = 'ðŸ”Š';
                toggleBtn.classList.remove('muted');
                toggleBtn.title = 'Mute Audio';
            } else {
                toggleBtn.textContent = 'ðŸ”‡';
                toggleBtn.classList.add('muted');
                toggleBtn.title = 'Unmute Audio';
                stopAllAudio();
            }
        }

        // Event listeners for navigation buttons
        nextBtn.addEventListener("click", () => {
            currentLevel++;
            if (currentLevel >= levels.length) currentLevel = 0;
            loadLevel(currentLevel);
        });

        solveBtn.addEventListener("click", () => {
            const target = levels[currentLevel].target;
            const slots = slotContainer.querySelectorAll(".slot");
            slots.forEach((s, i) => {
                s.dataset.id = target[i].id;
                s.innerText = target[i].id;
                s.style.border = "2px solid #fff";
            });
            triggerVictory();
        });

        // Start the game
        loadLevel(0);
        draw(ctx, targetPoints, circles, slotContainer, canvas);
    </script>
</body>
</html>
