<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Playground - Yay! Yay! Yay! Yay!</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        /* Playground-specific styles */
        .canvas-section {
            flex: 1;
            min-width: 400px;
        }
        
        .controls-section {
            flex: 1;
            min-width: 300px;
        }
        
        .controls-panel {
            background: #222;
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid #f0f;
        }
        
        .add-circle-btn {
            width: 100%;
            padding: 15px;
            background: #f0f;
            color: #000;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 20px;
        }
        
        .add-circle-btn:hover {
            opacity: 0.9;
        }
        
        .circle-card {
            background: #333;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid #555;
            position: relative;
        }
        
        .circle-card h3 {
            margin: 0 0 15px 0;
            color: #f0f;
        }
        
        .remove-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #f44;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        
        .remove-btn:hover {
            background: #f66;
        }
        
        .slider-group {
            margin: 10px 0;
        }
        
        .slider-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .slider {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #555;
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #f0f;
            cursor: pointer;
        }
        
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #f0f;
            cursor: pointer;
            border: none;
        }
        
        .value-display {
            min-width: 50px;
            text-align: right;
            font-family: monospace;
            font-size: 14px;
        }
        
        .color-picker {
            width: 40px;
            height: 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        @media (max-width: 800px) {
            .container {
                flex-direction: column;
            }
            
            .canvas-section, .controls-section {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div style="margin:auto; width: 100%; max-width: 800px; margin-bottom: 20px;">
        <a href="index.html">
            <img src="logo_sub.png" alt="Yay! Yay! Yay! Yay!" style="width: 100%;">
        </a>
    </div>
    
    <div class="container">
        <div class="canvas-section">
            <h1>ðŸŽ¨ Playground</h1>
            <div class="canvas-container">
                <canvas id="playgroundCanvas" width="400" height="400"></canvas>
            </div>
        </div>
        
        <div class="controls-section">
            <div class="controls-panel">
                <button class="add-circle-btn" onclick="addCircle()">âž• Add Circle</button>
                <button id="audioToggle" style="margin-top: 10px; padding: 5px 10px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px; cursor: pointer; touch-action: manipulation;">ðŸ”Š Audio: ON</button>
                <div id="circleList"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initAudio, updateCircleAudio, updateCircleVolume, stopAllAudio } from './js/audio.js';

        const canvas = document.getElementById('playgroundCanvas');
        const ctx = canvas.getContext('2d');
        const circleList = document.getElementById('circleList');
        
        let circles = [];
        let t = 0;
        let animationId;
        
        window.addCircle = function() {
            const circle = {
                id: Date.now(),
                r: 50,
                f: 1,
                p: 0,
                color: '#' + Math.floor(Math.random()*16777215).toString(16)
            };
            
            circles.push(circle);
            createCircleCard(circle);
            
            initAudio();
            updateCircleAudio(circle, true);
            
            updateAnimation();
        };
        
        window.removeCircle = function(id) {
            const circle = circles.find(c => c.id === id);
            if (circle) {
                updateCircleAudio(circle, false);
            }
            
            circles = circles.filter(c => c.id !== id);
            
            const cards = document.querySelectorAll('.circle-card');
            cards.forEach(card => {
                const removeBtn = card.querySelector('.remove-btn');
                if (removeBtn && removeBtn.getAttribute('onclick').includes(id.toString())) {
                    card.remove();
                }
            });
            
            updateAnimation();
        };
        
        function createCircleCard(circle) {
            const card = document.createElement('div');
            card.className = 'circle-card';
            card.innerHTML = `
                <div class="card-row1">
                    <h3 class="card-title">Circle ${circles.indexOf(circle) + 1}</h3>
                    <span class="color-label">Color:</span>
                    <input type="color" class="color-picker" value="${circle.color}" 
                           onchange="updateCircle(${circle.id}, 'color', this.value)">
                    <button class="remove-btn" onclick="removeCircle(${circle.id})">Ã—</button>
                </div>
                <div class="card-row2">
                    <div class="slider-col">
                        <label>Radius (r)<br><span class="value-display">${circle.r}</span></label>
                        <input type="range" class="slider" min="10" max="100" value="${circle.r}"
                               oninput="updateCircle(${circle.id}, 'r', parseFloat(this.value))">
                    </div>
                    <div class="slider-col">
                        <label>Frequency (f)<br><span class="value-display">${circle.f}</span></label>
                        <input type="range" class="slider" min="-3" max="3" step="0.05" value="${circle.f}"
                               oninput="updateCircle(${circle.id}, 'f', parseFloat(this.value))">
                    </div>
                    <div class="slider-col">
                        <label>Phase (p)<br><span class="value-display">${circle.p.toFixed(2)}</span></label>
                        <input type="range" class="slider" min="0" max="6.28" step="0.1" value="${circle.p}"
                               oninput="updateCircle(${circle.id}, 'p', parseFloat(this.value))">
                    </div>
                </div>
            `;
            circleList.appendChild(card);
        }
        
        window.updateCircle = function(id, property, value) {
            const circle = circles.find(c => c.id === id);
            if (circle) {
                circle[property] = value;
                
                updateCircleAudio(circle, true);
                updateAnimation();
                
                const card = event.target.closest('.circle-card');
                const labels = card.querySelectorAll('label');
                for (const label of labels) {
                    if ((property === 'r' && label.textContent.includes('Radius')) ||
                        (property !== 'r' && label.textContent.toLowerCase().includes(property.toLowerCase()))) {
                        const valueDisplay = label.querySelector('.value-display');
                        if (valueDisplay) {
                            valueDisplay.textContent = typeof value === 'number' ? value.toFixed(2) : value;
                        }
                        break;
                    }
                }
            }
        };
        
        function updateAnimation() {
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            animate();
        }
        
        function animate() {
            ctx.clearRect(0, 0, 400, 400);
            ctx.save();
            ctx.translate(200, 200);
            
            if (circles.length === 0) {
                ctx.fillStyle = "#666";
                ctx.font = "16px sans-serif";
                ctx.textAlign = "center";
                ctx.fillText("Add circles to see the pattern!", 0, 0);
                ctx.restore();
                return;
            }
            
            // Draw the combined pattern
            ctx.strokeStyle = "#fff";
            ctx.lineWidth = 1;
            ctx.beginPath();
            
            const points = [];
            const steps = 3000;
            const allInts = circles.length > 0 && circles.every(c => Number.isInteger(c.f));
            const cycles = allInts ? 1 : 20;
            const maxAngle = Math.PI * 2 * cycles;

            for (let i = 0; i <= steps; i++) {
                const angle = (i / steps) * maxAngle;
                let x = 0, y = 0;
                circles.forEach(circle => {
                    x += circle.r * Math.cos(circle.f * angle + circle.p);
                    y += circle.r * Math.sin(circle.f * angle + circle.p);
                });
                points.push({ x, y });
            }

            ctx.beginPath();
            ctx.moveTo(points[0].x, points[0].y);
            points.forEach(p => ctx.lineTo(p.x, p.y));
            ctx.stroke();
            
            // Draw chained epicycles
            let pos = { x: 0, y: 0 };
            circles.forEach((circle, index) => {
                ctx.strokeStyle = circle.color + "40";
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.arc(pos.x, pos.y, circle.r, 0, Math.PI * 2);
                ctx.stroke();
                
                const nextX = pos.x + circle.r * Math.cos(circle.f * t + circle.p);
                const nextY = pos.y + circle.r * Math.sin(circle.f * t + circle.p);
                
                updateCircleVolume(circle.id, nextY, nextX);
                
                ctx.strokeStyle = "#fff";
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(pos.x, pos.y);
                ctx.lineTo(nextX, nextY);
                ctx.stroke();
                
                ctx.fillStyle = circle.color;
                ctx.beginPath();
                ctx.arc(nextX, nextY, 4, 0, Math.PI * 2);
                ctx.fill();
                
                pos = { x: nextX, y: nextY };
            });
            
            ctx.restore();
            
            t += 0.02;
            animationId = requestAnimationFrame(animate);
        }
        
        // Add audio toggle functionality
        const audioToggleBtn = document.getElementById('audioToggle');
        audioToggleBtn.addEventListener("click", () => {
            initAudio();
            
            window.audioEnabled = !window.audioEnabled;
            audioToggleBtn.innerText = window.audioEnabled ? "ðŸ”Š Audio: ON" : "ðŸ”‡ Audio: OFF";
            if (!window.audioEnabled) {
                stopAllAudio();
            }
        });
        
        audioToggleBtn.addEventListener("touchend", (e) => {
            e.preventDefault();
            initAudio();
            
            window.audioEnabled = !window.audioEnabled;
            audioToggleBtn.innerText = window.audioEnabled ? "ðŸ”Š Audio: ON" : "ðŸ”‡ Audio: OFF";
            if (!window.audioEnabled) {
                stopAllAudio();
            }
        });
        
        // Start animation
        animate();
    </script>
</body>
</html>
